"""Malware detection module - identifies potential malware indicators"""

import re
from typing import List, Dict
import logging

logger = logging.getLogger(__name__)


class MalwareDetector:
    """Detects potential malware indicators and suspicious file/executable patterns"""

    def __init__(self):
        self.confidence = 0.0
        # Suspicious file extensions associated with malware
        self.malicious_extensions = [
            r"\.exe", r"\.scr", r"\.bat", r"\.cmd", r"\.com", r"\.vbs", r"\.js",
            r"\.jar", r"\.zip", r"\.rar", r"\.7z", r"\.iso", r"\.img", r"\.dmg"
        ]
        # Suspicious patterns in file names
        self.suspicious_patterns = [
            r"invoice.*\d+.*\.exe",
            r"document.*\.scr",
            r"payment.*\.vbs",
            r"(?:drop|dropper)",
            r"(?:trojan|backdoor|ransomware|worm|virus)",
        ]
        # Suspicious domains known for malware
        self.malicious_domains = [
            r"\.tk$", r"\.ml$", r"\.ga$", r"\.cf$",  # Suspicious free TLDs
            r"bit\.ly", r"tinyurl", r"short\.link",  # URL shorteners often used in malware
        ]

    def check_url_reputation(self, url: str) -> bool:
        """
        Check URL for malware reputation indicators
        Returns True if malware indicators found
        """
        url_lower = url.lower()
        self.confidence = 0.0

        # Check for suspicious file attachments in URLs
        if any(re.search(pattern, url_lower) for pattern in self.malicious_extensions):
            self.confidence += 0.4
            return self.confidence > 0.3

        # Check for URL shorteners
        if any(shortener in url_lower for shortener in ["bit.ly", "tinyurl", "short.link"]):
            self.confidence += 0.2  # URL shorteners hide true destination

        # Check for suspicious patterns
        for pattern in self.suspicious_patterns:
            if re.search(pattern, url_lower):
                self.confidence += 0.25

        # Check for malicious domains
        for pattern in self.malicious_domains:
            if re.search(pattern, url_lower):
                self.confidence += 0.15

        # DNS-based checks (simplified - in production would use real DNS services)
        if re.search(r"(?:ddns|duckdns|no-ip)", url_lower):
            self.confidence += 0.2  # Dynamic DNS often used for malware C&C

        return self.confidence > 0.3

    def check_attachment(self, filename: str) -> bool:
        """
        Check attachment filename for malware indicators
        Returns True if suspicious attachment detected
        """
        filename_lower = filename.lower()
        self.confidence = 0.0

        # Check file extension
        if any(re.search(pattern, filename_lower) for pattern in self.malicious_extensions):
            self.confidence += 0.4

        # Check for double extensions (common malware trick)
        if re.search(r"\.(txt|pdf|doc|docx|jpg|png)\.\w+$", filename_lower):
            self.confidence += 0.35

        # Check for suspicious naming patterns
        for pattern in self.suspicious_patterns:
            if re.search(pattern, filename_lower):
                self.confidence += 0.3

        # Whitespace attempts to hide real extension
        if " " in filename and self.confidence > 0:
            self.confidence += 0.15

        # Check for hidden attributes (common in Windows)
        if filename.startswith("."):
            self.confidence += 0.1

        return self.confidence > 0.3

    def detect_suspicious_content(self, content: str) -> bool:
        """
        Detect suspicious content that might indicate malware distribution
        """
        content_lower = content.lower()
        self.confidence = 0.0

        # Check for malware-related keywords
        malware_keywords = ["trojan", "ransomware", "virus", "worm", "backdoor", "exploit"]
        for keyword in malware_keywords:
            if keyword in content_lower:
                self.confidence += 0.15

        # Check for suspicious download requests
        if "download" in content_lower and any(ext in content_lower for ext in [".exe", ".scr", ".dll"]):
            self.confidence += 0.3

        return self.confidence > 0.3

    def get_confidence(self) -> float:
        """Get the confidence score of the last detection"""
        return min(1.0, self.confidence)
